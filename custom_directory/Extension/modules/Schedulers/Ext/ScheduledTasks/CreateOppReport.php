<?php
array_push($job_strings, 'CreateOppReport');

function CreateOppReport()
{
    if (RT_CO_GetOffset() < RT_CO_getAccountsSize()) {
        $acc = RT_CO_getAccountInfo();
        if (sizeof($acc) > 0) {
            $content = RT_CO_getReportsContent($acc);
            foreach ($content as $key => $value) {
                $report = BeanFactory::newBean('Reports');
                $report->module = 'Opportunities';
                $report->name = $key;
                $report->report_type = 'detailed_summary';
                $report->chart_type = strripos($key, 'Comms by Month for FY') == false ? 'vBarF' : 'hBarF';
                $report->content = $value;
                $report->assigned_user_id = '2110330c-c167-11ec-9f79-00163e104c13';
                $report->modified_user_id = '2110330c-c167-11ec-9f79-00163e104c13';
                $report->save();
            }
        } else {
            $GLOBALS['log']->falal("CreateOppReport :: " . RT_CO_getAccountsName() . " Account not Found");
        }
        RT_CO_updateOffset();
    } else {
        $query = 'Update schedulers set status = "Inactive" where name = "CreateOppReport"';
        $result = $GLOBALS['db']->query($query);
    }
    return true;
}
function RT_CO_getAccountInfo()
{
    $accountsInfo = [];
    $result = $GLOBALS['db']->query('SELECT id,name FROM accounts WHERE name like"' . RT_CO_getAccountsName() . '%" and deleted = 0');
    while ($row = $GLOBALS['db']->fetchByAssoc($result)) {
        $accountsInfo["'" . $row['id'] . "'"] = $row['name'];
    }
    return $accountsInfo;
}
function RT_CO_GetOffset()
{
    $result = $GLOBALS['db']->query("SELECT value FROM config WHERE name='CreateOppReportOffset'");
    $row = $GLOBALS['db']->fetchByAssoc($result);
    return $row['value'];
}

function RT_CO_getReportsContent($accountsInfo)
{
    $reportContent = [];
    $dim_db = [
        'US' => 'AMER',
        'CHINA' => 'APAC',
        'UK' => 'EMEA',
    ];
    $template = ['Dash - AccName Commissioned GP by Month' => '{"display_columns":[{"name":"auto_number","label":"P-Number","table_key":"self"},{"name":"name","label":"Project Name","table_key":"self"},{"name":"name","label":"Overcode Name","table_key":"Opportunities:accounts"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"commissioned_date_c","label":"Commissioned Date","table_key":"self"},{"name":"actual_sales_gbp_c","label":"Sales Value GBP","table_key":"self"},{"name":"grossprofit_gbp_c","label":"Gross Profit GBP","table_key":"self"},{"name":"full_name","label":"Name","table_key":"Opportunities:contacts_opportunities_1"},{"name":"csd_team_c","label":"CSD Team","table_key":"self"}],"module":"Opportunities","group_defs":[{"name":"commissioned_date_c","label":"Month: Commissioned Date","column_function":"month","qualifier":"month","table_key":"self","type":"date","force_label":"Month: Commissioned Date"},{"name":"sales_stage","label":"Sales Stage","table_key":"self","type":"enum","force_label":"Sales Stage"}],"summary_columns":[{"name":"commissioned_date_c","label":"Month: Commissioned Date","column_function":"month","qualifier":"month","table_key":"self"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"count","label":"Count","field_type":"","group_function":"count","table_key":"self"},{"name":"grossprofit_gbp_c","label":"SUM: Gross Profit GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"actual_sales_gbp_c","label":"SUM: Sales Value GBP","field_type":"decimal","group_function":"sum","table_key":"self"}],"report_name":"Dash - AccName Commissioned GP by Month","chart_type":"vBarF","do_round":1,"chart_description":"","numerical_chart_column":"self:grossprofit_gbp_c:sum","numerical_chart_column_type":"","assigned_user_id":"be79e2ec-e2fa-11eb-b150-00163e104c13","report_type":"summary","full_table_list":{"self":{"value":"Opportunities","module":"Opportunities","label":"Opportunities","dependents":[]},"Opportunities:accounts":{"name":"Opportunities  \u003E  Accounts","parent":"self","link_def":{"name":"accounts","relationship_name":"accounts_opportunities","bean_is_lhs":false,"link_type":"one","label":"Company Name","module":"Accounts","table_key":"Opportunities:accounts"},"dependents":["display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_9","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_8","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_8","Filter.1.2_table_filter_row_7","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_7","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_7","display_cols_row_8"],"module":"Accounts","label":"Company Name","optional":true},"Opportunities:contacts_opportunities_1":{"name":"Opportunities  \u003E  Primary Contact","parent":"self","link_def":{"name":"contacts_opportunities_1","relationship_name":"contacts_opportunities_1","bean_is_lhs":false,"link_type":"one","label":"Primary Contact","module":"Contacts","table_key":"Opportunities:contacts_opportunities_1"},"dependents":["display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_7","display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13"],"module":"Contacts","label":"Primary Contact","optional":true}},"filters_def":{"Filter_1":{"0":{"operator":"AND","0":{"name":"sales_stage","table_key":"self","qualifier_name":"one_of","runtime":1,"input_name0":["Commissioned","Closed (Debriefed)","Closed (Fully Invoiced)"]},"1":{"name":"commissioned_date_c","table_key":"self","qualifier_name":"after","runtime":1,"input_name0":"2023-03-31","input_name1":"on"}},"1":AccountsInfo,"operator":"AND"}}}',
        'Dash -AccName Commissionings by Month' => '{"display_columns":[{"name":"auto_number","label":"P-Number","table_key":"self"},{"name":"name","label":"Project Name","table_key":"self"},{"name":"name","label":"Overcode Name","table_key":"Opportunities:accounts"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"commissioned_date_c","label":"Commissioned Date","table_key":"self"},{"name":"actual_sales_gbp_c","label":"Sales Value GBP","table_key":"self"},{"name":"grossprofit_gbp_c","label":"Gross Profit GBP","table_key":"self"},{"name":"full_name","label":"Name","table_key":"Opportunities:contacts_opportunities_1"},{"name":"csd_team_c","label":"CSD Team","table_key":"self"}],"module":"Opportunities","group_defs":[{"name":"commissioned_date_c","label":"Month: Commissioned Date","column_function":"month","qualifier":"month","table_key":"self","type":"date","force_label":"Month: Commissioned Date"},{"name":"sales_stage","label":"Sales Stage","table_key":"self","type":"enum","force_label":"Sales Stage"}],"summary_columns":[{"name":"commissioned_date_c","label":"Month: Commissioned Date","column_function":"month","qualifier":"month","table_key":"self"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"count","label":"Count","field_type":"","group_function":"count","table_key":"self"},{"name":"grossprofit_gbp_c","label":"SUM: Gross Profit GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"actual_sales_gbp_c","label":"SUM: Sales Value GBP","field_type":"decimal","group_function":"sum","table_key":"self"}],"report_name":"Dash - AccName Commissionings by Month","chart_type":"vBarF","do_round":1,"chart_description":"","numerical_chart_column":"self:count","numerical_chart_column_type":"","assigned_user_id":"be79e2ec-e2fa-11eb-b150-00163e104c13","report_type":"summary","full_table_list":{"self":{"value":"Opportunities","module":"Opportunities","label":"Opportunities","dependents":[]},"Opportunities:accounts":{"name":"Opportunities  \u003E  Accounts","parent":"self","link_def":{"name":"accounts","relationship_name":"accounts_opportunities","bean_is_lhs":false,"link_type":"one","label":"Company Name","module":"Accounts","table_key":"Opportunities:accounts"},"dependents":["display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_9","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_8","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_8","Filter.1.2_table_filter_row_7"],"module":"Accounts","label":"Company Name","optional":true},"Opportunities:contacts_opportunities_1":{"name":"Opportunities  \u003E  Primary Contact","parent":"self","link_def":{"name":"contacts_opportunities_1","relationship_name":"contacts_opportunities_1","bean_is_lhs":false,"link_type":"one","label":"Primary Contact","module":"Contacts","table_key":"Opportunities:contacts_opportunities_1"},"dependents":["display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_7","display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13"],"module":"Contacts","label":"Primary Contact","optional":true}},"filters_def":{"Filter_1":{"0":{"operator":"AND","0":{"name":"sales_stage","table_key":"self","qualifier_name":"one_of","runtime":1,"input_name0":["Commissioned","Closed (Debriefed)","Closed (Fully Invoiced)"]},"1":{"name":"commissioned_date_c","table_key":"self","qualifier_name":"after","runtime":1,"input_name0":"2023-03-31","input_name1":"on"}},"1":AccountsInfo,"operator":"AND"}}}',
        'Dash - AccName Comms by Month for FY' => '{"display_columns":[{"name":"auto_number","label":"P-Number","table_key":"self"},{"name":"name","label":"Project Name","table_key":"self"},{"name":"overcode_c","label":"Overcode","table_key":"Opportunities:accounts"},{"name":"commissioned_date_c","label":"Commissioned Date","table_key":"self"},{"name":"full_name","label":"Full Name","table_key":"Opportunities:assigned_user_link"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"actual_sales_gbp_c","label":"Sales Value GBP","table_key":"self"},{"name":"grossprofit_gbp_c","label":"Gross Profit GBP","table_key":"self"},{"name":"csd_team_c","label":"CSD Team","table_key":"self"},{"name":"default_dim_db_c","label":"Default Dimensions database","table_key":"self"}],"module":"Opportunities","group_defs":[{"name":"commissioned_date_c","label":"Month: Commissioned Date","column_function":"month","qualifier":"month","table_key":"self","type":"date","force_label":"Month: Commissioned Date"}],"summary_columns":[{"name":"commissioned_date_c","label":"Month: Commissioned Date","column_function":"month","qualifier":"month","table_key":"self"},{"name":"actual_sales_gbp_c","label":"SUM: Sales Value GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"grossprofit_gbp_c","label":"SUM: Gross Profit GBP","field_type":"decimal","group_function":"sum","table_key":"self"}],"report_name":"Dash - AccName Comms by Month for FY","chart_type":"hBarF","do_round":1,"chart_description":"","numerical_chart_column":"self:grossprofit_gbp_c:sum","numerical_chart_column_type":"","assigned_user_id":"be79e2ec-e2fa-11eb-b150-00163e104c13","report_type":"summary","full_table_list":{"self":{"value":"Opportunities","module":"Opportunities","label":"Opportunities","dependents":[]},"Opportunities:assigned_user_link":{"name":"Projects  \u003E  Assigned to User","parent":"self","link_def":{"name":"assigned_user_link","relationship_name":"opportunities_assigned_user","bean_is_lhs":false,"link_type":"one","label":"Assigned to User","module":"Users","table_key":"Opportunities:assigned_user_link"},"dependents":["display_cols_row_8","display_cols_row_7","display_cols_row_5","display_cols_row_5","display_cols_row_5","display_cols_row_5","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8"],"module":"Users","label":"Assigned to User","optional":true},"Opportunities:accounts":{"name":"Projects  \u003E  Companies","parent":"self","link_def":{"name":"accounts","relationship_name":"accounts_opportunities","bean_is_lhs":false,"link_type":"many","label":"Accounts","module":"Accounts","table_key":"Opportunities:accounts"},"dependents":["display_cols_row_6","display_cols_row_3","display_cols_row_3","display_cols_row_3","display_cols_row_3","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","display_cols_row_6","Filter.1.2_table_filter_row_9","Filter.1.2_table_filter_row_10","Filter.1.2_table_filter_row_11","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_6","display_cols_row_6","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_6","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_6","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_6","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_6","Filter.1.2_table_filter_row_7","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_7","display_cols_row_6","Filter.1.2_table_filter_row_8"],"module":"Accounts","label":"Accounts","optional":true}},"filters_def":{"Filter_1":{"0":{"operator":"AND","0":{"name":"commissioned_date_c","table_key":"self","qualifier_name":"between_dates","runtime":1,"input_name0":"2023-04-01","input_name1":"2024-03-31"},"1":{"name":"default_dim_db_c","table_key":"self","qualifier_name":"not_empty","input_name0":"not_empty","input_name1":"on"},"2":{"name":"sales_stage","table_key":"self","qualifier_name":"one_of","input_name0":["Commissioned","Closed (Debriefed)","Closed (Fully Invoiced)"]}},"1":AccountsInfo,"operator":"AND"}}}',
        'Dash - AccName GP 2020-23' => '{"display_columns":[{"name":"overcode_c","label":"Overcode","table_key":"Opportunities:accounts"},{"name":"auto_number","label":"P-Number","table_key":"self"},{"name":"name","label":"Project Name","table_key":"self"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"rp_complete_c","label":"Research Complete?","table_key":"self"},{"name":"commercial_lead_c","label":"Commercial Lead","table_key":"self"},{"name":"user_name","label":"User Name","table_key":"Opportunities:assigned_user_link"},{"name":"actual_sales_gbp_c","label":"Sales Value GBP","table_key":"self"},{"name":"grossprofit_gbp_c","label":"Gross Profit GBP","table_key":"self"},{"name":"hc_grossprofit_c","label":"Gross Profit (home currency)","table_key":"self"},{"name":"date_entered","label":"Date Created","table_key":"self"},{"name":"commissioned_date_c","label":"Commissioned Date","table_key":"self"},{"name":"qual_percent_new_c","label":"Qual Percent","table_key":"self"},{"name":"expert_sensory_checkbox_c","label":"Expert Sensory?","table_key":"self"},{"name":"expressyesno_c","label":"Is this an Express project?","table_key":"self"},{"name":"sensory_qual_c","label":"Sensory Qual?","table_key":"self"},{"name":"description","label":"Description","table_key":"self"},{"name":"loss_reason_text_c","label":"Please give further details","table_key":"self"},{"name":"csd_team_c","label":"CSD Team","table_key":"self"}],"module":"Opportunities","group_defs":[{"name":"commissioned_financial_year_c","label":"commissioned_financial_year_c","table_key":"self","type":"varchar","force_label":"commissioned_financial_year_c"}],"summary_columns":[{"name":"commissioned_financial_year_c","label":"commissioned_financial_year_c","table_key":"self"},{"name":"actual_sales_gbp_c","label":"SUM: Sales Value GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"grossprofit_gbp_c","label":"SUM: Gross Profit GBP","field_type":"decimal","group_function":"sum","table_key":"self"}],"report_name":"Dash - AccName GP 2020-23","chart_type":"vBarF","do_round":1,"chart_description":"Empire GP","numerical_chart_column":"self:grossprofit_gbp_c:sum","numerical_chart_column_type":"","assigned_user_id":"be79e2ec-e2fa-11eb-b150-00163e104c13","report_type":"summary","order_by":[{"options":[{"value":"=","text":"Equals"},{"value":"not_equal","text":"Not On"},{"value":"greater_than","text":"After"},{"value":"less_than","text":"Before"},{"value":"last_7_days","text":"Last 7 Days"},{"value":"next_7_days","text":"Next 7 Days"},{"value":"last_30_days","text":"Last 30 Days"},{"value":"next_30_days","text":"Next 30 Days"},{"value":"last_month","text":"Last Month"},{"value":"this_month","text":"This Month"},{"value":"next_month","text":"Next Month"},{"value":"last_year","text":"Last Year"},{"value":"this_year","text":"This Year"},{"value":"next_year","text":"Next Year"},{"value":"between","text":"Is Between"}],"enable_range_search":"1","source":"custom_fields","name":"commissioned_date_c","vname":"Commissioned Date","type":"date","importable":"true","duplicate_merge":"disabled","reportable":true,"merge_filter":"disabled","size":"20","id":"Opportunitiescommissioned_date_c","custom_module":"Opportunities","table_key":"self","sort_dir":"a"}],"full_table_list":{"self":{"value":"Opportunities","module":"Opportunities","label":"Opportunities","dependents":[]},"Opportunities:accounts":{"name":"Opportunities  \u003E  Accounts","parent":"self","link_def":{"name":"accounts","relationship_name":"accounts_opportunities","bean_is_lhs":false,"link_type":"one","label":"Company Name","module":"Accounts","table_key":"Opportunities:accounts"},"dependents":["display_cols_row_10","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","display_cols_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_4","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_4","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_4","Filter.1.2_table_filter_row_7"],"module":"Accounts","label":"Company Name","optional":true},"Opportunities:assigned_user_link":{"name":"Opportunities  \u003E  Assigned to User","parent":"self","link_def":{"name":"assigned_user_link","relationship_name":"opportunities_assigned_user","bean_is_lhs":false,"link_type":"one","label":"Assigned to User","module":"Users","table_key":"Opportunities:assigned_user_link"},"dependents":["display_cols_row_15","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10"],"module":"Users","label":"Assigned to User","optional":true}},"filters_def":{"Filter_1":{"0":{"operator":"AND","0":{"name":"commissioned_date_c","table_key":"self","qualifier_name":"between_dates","runtime":1,"input_name0":"2023-04-01","input_name1":"2024-03-31"},"1":{"name":"sales_stage","table_key":"self","qualifier_name":"one_of","runtime":1,"input_name0":["Commissioned","Closed (Debriefed)","Closed (Fully Invoiced)"]}},"1":AccountsInfo,"operator":"AND"}}}',
        'Dash - AccName Opps & Proposals by Month' => '{"display_columns":[{"name":"auto_number","label":"P-Number","table_key":"self"},{"name":"name","label":"Project Name","table_key":"self"},{"name":"name","label":"Overcode Name","table_key":"Opportunities:accounts"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"date_closed","label":"Estimated Commission Date","table_key":"self"},{"name":"revenue_gbp_c","label":"Estimated Sales GBP","table_key":"self"},{"name":"grossprofit_estimate_gbp_c","label":"Estimated Gross Profit GBP","table_key":"self"},{"name":"full_name","label":"Name","table_key":"Opportunities:contacts_opportunities_1"},{"name":"csd_team_c","label":"CSD Team","table_key":"self"}],"module":"Opportunities","group_defs":[{"name":"date_entered","label":"Month: Date Created","column_function":"month","qualifier":"month","table_key":"self","type":"datetime","force_label":"Month: Date Created"},{"name":"sales_stage","label":"Sales Stage","table_key":"self","type":"enum","force_label":"Sales Stage"}],"summary_columns":[{"name":"date_entered","label":"Month: Date Created","column_function":"month","qualifier":"month","table_key":"self"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"revenue_gbp_c","label":"SUM: Estimated Sales GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"grossprofit_estimate_gbp_c","label":"SUM: Estimated Gross Profit GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"count","label":"Count","field_type":"","group_function":"count","table_key":"self"}],"report_name":"Dash - AccName Opps \u0026 Proposals by Month","chart_type":"vBarF","do_round":1,"chart_description":"","numerical_chart_column":"self:count","numerical_chart_column_type":"","assigned_user_id":"be79e2ec-e2fa-11eb-b150-00163e104c13","report_type":"summary","full_table_list":{"self":{"value":"Opportunities","module":"Opportunities","label":"Opportunities","dependents":[]},"Opportunities:accounts":{"name":"Opportunities  \u003E  Accounts","parent":"self","link_def":{"name":"accounts","relationship_name":"accounts_opportunities","bean_is_lhs":false,"link_type":"one","label":"Company Name","module":"Accounts","table_key":"Opportunities:accounts"},"dependents":["display_cols_row_11","display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_9","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_8","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_8","Filter.1.2_table_filter_row_7"],"module":"Accounts","label":"Company Name","optional":true},"Opportunities:contacts_opportunities_1":{"name":"Opportunities  \u003E  Primary Contact","parent":"self","link_def":{"name":"contacts_opportunities_1","relationship_name":"contacts_opportunities_1","bean_is_lhs":false,"link_type":"one","label":"Primary Contact","module":"Contacts","table_key":"Opportunities:contacts_opportunities_1"},"dependents":["display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_7","display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13"],"module":"Contacts","label":"Primary Contact","optional":true}},"filters_def":{"Filter_1":{"0":{"operator":"AND","0":{"name":"sales_stage","table_key":"self","qualifier_name":"one_of","runtime":1,"input_name0":["Unposted Enquiry","Posted Proposal"]},"1":{"name":"date_entered","table_key":"self","qualifier_name":"after","runtime":1,"input_name0":"2023-03-31","input_name1":"on"}},"1":AccountsInfo,"operator":"AND"}}}',
        'Dash - AccName Opps & Proposals Estimated GP by Month' => '{"display_columns":[{"name":"auto_number","label":"P-Number","table_key":"self"},{"name":"name","label":"Project Name","table_key":"self"},{"name":"name","label":"Overcode Name","table_key":"Opportunities:accounts"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"date_closed","label":"Estimated Commission Date","table_key":"self"},{"name":"revenue_gbp_c","label":"Estimated Sales GBP","table_key":"self"},{"name":"grossprofit_estimate_gbp_c","label":"Estimated Gross Profit GBP","table_key":"self"},{"name":"full_name","label":"Name","table_key":"Opportunities:contacts_opportunities_1"},{"name":"csd_team_c","label":"CSD Team","table_key":"self"}],"module":"Opportunities","group_defs":[{"name":"date_entered","label":"Month: Date Created","column_function":"month","qualifier":"month","table_key":"self","type":"datetime","force_label":"Month: Date Created"},{"name":"sales_stage","label":"Sales Stage","table_key":"self","type":"enum","force_label":"Sales Stage"}],"summary_columns":[{"name":"date_entered","label":"Month: Date Created","column_function":"month","qualifier":"month","table_key":"self"},{"name":"sales_stage","label":"Sales Stage","table_key":"self"},{"name":"grossprofit_estimate_gbp_c","label":"SUM: Estimated Gross Profit GBP","field_type":"decimal","group_function":"sum","table_key":"self"},{"name":"count","label":"Count","field_type":"","group_function":"count","table_key":"self"},{"name":"revenue_gbp_c","label":"SUM: Estimated Sales GBP","field_type":"decimal","group_function":"sum","table_key":"self"}],"report_name":"Dash - AccName Opps \u0026 Proposals Estimated GP by Month","chart_type":"vBarF","do_round":1,"chart_description":"","numerical_chart_column":"self:grossprofit_estimate_gbp_c:sum","numerical_chart_column_type":"","assigned_user_id":"be79e2ec-e2fa-11eb-b150-00163e104c13","report_type":"summary","full_table_list":{"self":{"value":"Opportunities","module":"Opportunities","label":"Opportunities","dependents":[]},"Opportunities:accounts":{"name":"Opportunities  \u003E  Accounts","parent":"self","link_def":{"name":"accounts","relationship_name":"accounts_opportunities","bean_is_lhs":false,"link_type":"one","label":"Company Name","module":"Accounts","table_key":"Opportunities:accounts"},"dependents":["display_cols_row_11","display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","display_cols_row_11","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_11","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_9","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_10","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","display_cols_row_8","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","display_cols_row_8","Filter.1.2_table_filter_row_6","Filter.1.2_table_filter_row_3","Filter.1.2_table_filter_row_4","Filter.1.2_table_filter_row_5","Filter.1.2_table_filter_row_6","display_cols_row_8","Filter.1.2_table_filter_row_7"],"module":"Accounts","label":"Company Name","optional":true},"Opportunities:contacts_opportunities_1":{"name":"Opportunities  \u003E  Primary Contact","parent":"self","link_def":{"name":"contacts_opportunities_1","relationship_name":"contacts_opportunities_1","bean_is_lhs":false,"link_type":"one","label":"Primary Contact","module":"Contacts","table_key":"Opportunities:contacts_opportunities_1"},"dependents":["display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_7","display_cols_row_7","display_cols_row_7","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_9","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_10","display_cols_row_8","display_cols_row_9","display_cols_row_9","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13","display_cols_row_13"],"module":"Contacts","label":"Primary Contact","optional":true}},"filters_def":{"Filter_1":{"0":{"operator":"AND","0":{"name":"sales_stage","table_key":"self","qualifier_name":"one_of","runtime":1,"input_name0":["Unposted Enquiry","Posted Proposal"]},"1":{"name":"date_entered","table_key":"self","qualifier_name":"after","runtime":1,"input_name0":"2023-03-31","input_name1":"on"}},"1":AccountsInfo,"operator":"AND"}}}',
    ];
    $accFilter = RT_CO_getAccountFilter($accountsInfo);
    foreach ($template as $key => $value) {
        $reportContent[str_replace('AccName', RT_CO_getAccountsName(), $key)] = str_replace('AccountsInfo', $accFilter, str_replace("AccName", RT_CO_getAccountsName(), $value));
        foreach ($dim_db as $key1 => $value1) {
            $reportContent[str_replace('AccName', RT_CO_getAccountsName() . ' ' . $value1, $key)] = RT_CO_addDBDimensionFilter(str_replace('AccountsInfo', $accFilter, str_replace("AccName ", RT_CO_getAccountsName() . ' ' . $value1.' ', $value)), $key1);
        }
    }
    return $reportContent;
}
function RT_CO_getAccountFilter($acc)
{
    $filter = array("operator" => "OR");
    foreach ($acc as $key => $value) {
        array_push($filter, array('name' => 'name',
            'table_key' => 'Opportunities:accounts',
            'qualifier_name' => 'is', 'input_name0' => $key, 'input_name1' => $value));
    }
    return json_encode($filter);
}
function RT_CO_addDBDimensionFilter($content, $value)
{
    $found = false;
    $data = json_decode($content, true);
    foreach ($data['filters_def']['Filter_1'][0] as $key1 => $Filter1) {
        if (isset($Filter1) && is_array($Filter1)) {
            if (isset($Filter1['name']) && $Filter1['name'] == 'default_dim_db_c') {
                $data['filters_def']['Filter_1'][0][$key1]['qualifier_name'] = 'one_of';
                $data['filters_def']['Filter_1'][0][$key1]['input_name0'] = [$value];
                $data['filters_def']['Filter_1'][0][$key1]['runtime'] = 1;
                unset($data['filters_def']['Filter_1'][0][$key1]['input_name1']);
                $found = true;
            }
        }
    }
    if ($found == false) {
        array_push($data['filters_def']['Filter_1'][0], array("name" => "default_dim_db_c", "table_key" => "self", "qualifier_name" => "one_of", "runtime" => 1, "input_name0" => [$value]));
    }

    return json_encode($data);
}
// /**Update Offset in config Table */
function RT_CO_updateOffset()
{
    $query = 'Update config set value = value + 1 WHERE name="CreateOppReportOffset"';
    $result = $GLOBALS['db']->query($query);
}

function RT_CO_getAccountsName()
{
    $accounts = ['TATE & LYLE', 'COLGATE PALMOLIVE', 'Juul', 'Keurig Dr Pepper', 'BEYOND MEAT', 'Daiya Foods', 'CEREAL PARTNERS', 'GSK', 'MOLSON COORS', 'COCA-COLA', 'INSPIRE BRANDS', 'MARS', 'BLUE DIAMOND', 'CHURCH & DWIGHT', 'Church & Dwight Co. Inc.', 'DANONE', 'DANONEWAVE', 'ALPRO', 'NUTRICIA', "L'OREAL"];
    $offset = RT_CO_GetOffset();
    return $accounts[$offset];
}
function RT_CO_getAccountsSize()
{
    $accounts = ['TATE & LYLE', 'COLGATE PALMOLIVE', 'Juul', 'Keurig Dr Pepper', 'BEYOND MEAT', 'Daiya Foods', 'CEREAL PARTNERS', 'GSK', 'MOLSON COORS', 'COCA-COLA', 'INSPIRE BRANDS', 'MARS', 'BLUE DIAMOND', 'CHURCH & DWIGHT', 'Church & Dwight Co. Inc.', 'DANONE', 'DANONEWAVE', 'ALPRO', 'NUTRICIA', "L'OREAL"];
    return count($accounts);
}